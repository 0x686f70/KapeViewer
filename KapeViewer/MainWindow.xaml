<Window x:Class="KapeViewer.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:KapeViewer"
        xmlns:models="clr-namespace:KapeViewer.Models"
        mc:Ignorable="d"
        Title="KAPE Viewer" Height="800" Width="1200">
    <DockPanel>
        <!-- Menu Bar at top -->
        <Menu DockPanel.Dock="Top">
            <MenuItem Header="_File">
                <MenuItem Header="_Open Case" Click="OpenCase_Click" InputGestureText="Ctrl+O"/>
                <Separator/>
                <MenuItem Header="E_xit" Click="Exit_Click"/>
            </MenuItem>
            <MenuItem Header="_Tools">
                <MenuItem Header="Build Global _Timeline" Click="BuildTimeline_Click" InputGestureText="Ctrl+T"/>
            </MenuItem>
        </Menu>

        <!-- Toolbar -->
        <ToolBarTray DockPanel.Dock="Top">
            <ToolBar>
                <!-- Action Buttons -->
                <Button Content="📁 Open Case" Click="OpenCase_Click" ToolTip="Open KAPE case folder (Ctrl+O)"/>
                <Button Content="🔄 Refresh" Click="Refresh_Click" ToolTip="Refresh case folder (F5)"/>
                <Button Content="⏱️ Build Global Timeline" Click="BuildTimeline_Click" ToolTip="Merge all CSV files into timeline (Ctrl+T)"/>
                
                <Separator/>
                
                <!-- Date Range Filters -->
                <TextBlock Text="From:" VerticalAlignment="Center" Margin="5,0"/>
                <DatePicker x:Name="FromDatePicker" Width="120" SelectedDateChanged="DateFilter_Changed" ToolTip="Filter start date"/>
                
                <TextBlock Text="To:" VerticalAlignment="Center" Margin="5,0"/>
                <DatePicker x:Name="ToDatePicker" Width="120" SelectedDateChanged="DateFilter_Changed" ToolTip="Filter end date"/>
                
                <ToggleButton x:Name="UtcLocalToggle" Content="UTC" Width="50" Click="ToggleUtcLocal_Click" ToolTip="Toggle between UTC and Local time"/>
                
                <Separator/>
                
                <!-- Source Filter -->
                <TextBlock Text="Source:" VerticalAlignment="Center" Margin="5,0"/>
                <ComboBox x:Name="SourceFilterComboBox" Width="150" SelectionChanged="SourceFilter_Changed" ToolTip="Filter by source group"/>
                
                <!-- Quick Search -->
                <TextBlock Text="Search:" VerticalAlignment="Center" Margin="5,0"/>
                <TextBox x:Name="QuickSearchTextBox" Width="200" TextChanged="QuickSearch_Changed" ToolTip="Search all columns">
                    <TextBox.Style>
                        <Style TargetType="TextBox">
                            <Style.Triggers>
                                <Trigger Property="Text" Value="">
                                    <Setter Property="Background">
                                        <Setter.Value>
                                            <VisualBrush Stretch="None" AlignmentX="Left">
                                                <VisualBrush.Visual>
                                                    <TextBlock Text="Search all columns..." Foreground="Gray" Margin="5,0,0,0"/>
                                                </VisualBrush.Visual>
                                            </VisualBrush>
                                        </Setter.Value>
                                    </Setter>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </TextBox.Style>
                </TextBox>
                
                <Separator/>
                
                <!-- Export and View Controls -->
                <Button x:Name="ExportButton" Content="💾 Export" ToolTip="Export current view">
                    <Button.ContextMenu>
                        <ContextMenu>
                            <MenuItem Header="Export Current Table" Click="ExportTable_Click"/>
                            <MenuItem Header="Export Timeline" Click="ExportTimeline_Click"/>
                        </ContextMenu>
                    </Button.ContextMenu>
                </Button>
                <Button Content="📋 Columns" Click="ShowColumnsDialog_Click" ToolTip="Show/hide columns"/>
                <Button Content="📄 Copy" Click="CopyRows_Click" ToolTip="Copy selected rows (Ctrl+C)"/>
                <Button Content="↔️ Auto-size" Click="AutoSizeColumns_Click" ToolTip="Auto-size columns"/>
                
                <!-- Spacer to push row count to the right -->
                <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" Width="Auto" HorizontalAlignment="Stretch"/>
                
                <!-- Row Count Label -->
                <TextBlock x:Name="RowCountLabel" Text="Rows: 0" VerticalAlignment="Center" Margin="10,0" FontWeight="Bold"/>
            </ToolBar>
        </ToolBarTray>

        <!-- Status Bar at bottom -->
        <StatusBar DockPanel.Dock="Bottom" x:Name="StatusBar">
            <TextBlock x:Name="StatusBarCasePath" Text="No case loaded" Margin="5,0"/>
            <Separator/>
            <TextBlock x:Name="StatusBarViewName" Text="Table" Margin="5,0"/>
            <Separator/>
            <TextBlock x:Name="StatusBarRowCount" Text="Rows: 0" Margin="5,0"/>
        </StatusBar>

        <!-- Main content area -->
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="250"/>
                <ColumnDefinition Width="5"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- TreeView for file navigation -->
            <TreeView Grid.Column="0" 
                      x:Name="FileTreeView"
                      SelectedItemChanged="TreeView_SelectedItemChanged">
                <TreeView.Resources>
                    <!-- Template for GroupNode -->
                    <HierarchicalDataTemplate DataType="{x:Type models:GroupNode}" 
                                              ItemsSource="{Binding Files}">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="{Binding Name}" FontWeight="Bold"/>
                            <TextBlock Text=" (" Margin="5,0,0,0"/>
                            <TextBlock Text="{Binding FileCount}"/>
                            <TextBlock Text=")"/>
                        </StackPanel>
                    </HierarchicalDataTemplate>
                    
                    <!-- Template for CsvFileItem -->
                    <DataTemplate DataType="{x:Type models:CsvFileItem}">
                        <TextBlock Text="{Binding DisplayName}"/>
                    </DataTemplate>
                </TreeView.Resources>
            </TreeView>

            <!-- GridSplitter -->
            <GridSplitter Grid.Column="1" 
                          Width="5" 
                          HorizontalAlignment="Stretch" 
                          VerticalAlignment="Stretch"/>

            <!-- Right side content with TabControl -->
            <TabControl Grid.Column="2" x:Name="MainTabControl">
                <!-- Table Tab -->
                <TabItem Header="Table">
                    <DataGrid x:Name="TableDataGrid"
                              AutoGenerateColumns="True"
                              IsReadOnly="True"
                              EnableRowVirtualization="True"
                              EnableColumnVirtualization="True"
                              SelectionMode="Extended"
                              CanUserSortColumns="True"
                              CanUserReorderColumns="True"
                              VirtualizingPanel.IsVirtualizing="True"
                              VirtualizingPanel.VirtualizationMode="Recycling"/>
                </TabItem>
                
                <!-- Timeline Tab -->
                <TabItem Header="Timeline">
                    <ListView x:Name="TimelineListView"
                              VirtualizingPanel.IsVirtualizing="True"
                              VirtualizingPanel.VirtualizationMode="Recycling">
                        <ListView.View>
                            <GridView>
                                <GridViewColumn Header="Timestamp" Width="200">
                                    <GridViewColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Timestamp, StringFormat='yyyy-MM-dd HH:mm:ss.fff'}"/>
                                        </DataTemplate>
                                    </GridViewColumn.CellTemplate>
                                </GridViewColumn>
                                <GridViewColumn Header="Source" Width="200" DisplayMemberBinding="{Binding Source}"/>
                                <GridViewColumn Header="Description" Width="600" DisplayMemberBinding="{Binding Description}"/>
                            </GridView>
                        </ListView.View>
                    </ListView>
                </TabItem>
            </TabControl>
        </Grid>
    </DockPanel>
</Window>
